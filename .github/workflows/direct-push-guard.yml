name: Direct Push Guard

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Enforce direct push policy
        env:
          ACTOR: ${{ github.actor }}
          OWNER: ${{ github.repository_owner }}
          ALLOWED: ${{ vars.ALLOWED_DIRECT_PUSH_USERS }}
        run: |
          allowed_list="${ALLOWED//,/ }"
          if [ "$ACTOR" = "$OWNER" ]; then
            exit 0
          fi
          for user in $allowed_list; do
            if [ "$ACTOR" = "$user" ]; then
              exit 0
            fi
          done
          echo "::error::Direct pushes to main are not allowed for $ACTOR. Use a PR."
          exit 1
